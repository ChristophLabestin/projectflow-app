rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function authed() {
      return request.auth != null;
    }
    
    function isOwner(tenantId) {
      return authed() && request.auth.uid == tenantId;
    }
    
    // Check if user is a member of the tenant (using members subcollection)
    function isTenantMember(tenantId) {
      return authed() && exists(/databases/$(database)/documents/tenants/$(tenantId)/members/$(request.auth.uid));
    }
    
    function canAccessTenant(tenantId) {
      return isOwner(tenantId) || isTenantMember(tenantId);
    }
    
    // Check if user is a member of a specific project (supports external users)
    function isProjectMember(projectData) {
      return authed() && (
        projectData.ownerId == request.auth.uid ||
        request.auth.uid in projectData.memberIds
      );
    }

    // --- Public Collections (no auth required) ---
    match /waitlist/{email} { 
      allow read, write: if true; 
    }
    match /newsletter/{email} { 
      allow read, write: if true; 
    }
    match /contact_submissions/{doc} { 
      allow create: if true; 
    }
    match /blog_posts/{post} { 
      allow read: if true; 
    }
    match /news/{doc} { 
      allow read: if true; 
    }

    // --- Top-level Users Collection (global user profiles) ---
    match /users/{userId} {
      // Users can read/write their own profile
      allow read, write: if authed() && request.auth.uid == userId;
      // Any authenticated user can read profiles (for team lists, @mentions, etc.)
      allow read: if authed();
    }

    // --- Tenant Rules ---
    match /tenants/{tenantId} {
      // Owner or member can read tenant
      allow read: if canAccessTenant(tenantId);
      // Only owner can write tenant doc
      allow write: if isOwner(tenantId);

      // Members subcollection (workspace membership)
      match /members/{userId} {
        // Tenant members can read all memberships
        allow read: if canAccessTenant(tenantId);
        // Owner can manage all memberships
        allow write: if isOwner(tenantId);
        // Users can write their own membership (for joining)
        allow write: if authed() && request.auth.uid == userId;
      }
      
      // Presence subcollection
      match /presence/{presenceId} {
        allow read, write: if canAccessTenant(tenantId);
      }
      
      // Invite links - public read
      match /invite_links/{linkId} {
        allow read: if true;
        allow write: if isOwner(tenantId);
      }
      match /inviteLinks/{linkId} {
        allow read: if true;
        allow write: if isOwner(tenantId);
      }

      // Projects within tenant
      match /projects/{projectId} {
        // Tenant members OR project members (including external) can access
        allow read: if canAccessTenant(tenantId) || isProjectMember(resource.data);
        // Write requires tenant membership OR being project owner/member
        allow write: if canAccessTenant(tenantId) || isProjectMember(resource.data);

        // All project subcollections (tasks, issues, ideas, etc.)
        match /{subcollection}/{docId} {
          // Allow if user can access tenant OR is in project's memberIds
          allow read, write: if canAccessTenant(tenantId) || 
            isProjectMember(get(/databases/$(database)/documents/tenants/$(tenantId)/projects/$(projectId)).data);
          
          match /{nestedCollection}/{nestedDocId} {
            allow read, write: if canAccessTenant(tenantId) ||
              isProjectMember(get(/databases/$(database)/documents/tenants/$(tenantId)/projects/$(projectId)).data);
          }
        }
      }
      
      // Catch-all for OTHER tenant subcollections (notifications, groups, etc.)
      match /{subcollection}/{docId} {
        allow read, write: if canAccessTenant(tenantId);
      }
    }

    // --- CollectionGroup queries ---
    // Projects (for getSharedProjects - external users finding their projects)
    match /{path=**}/projects/{projectId} {
      allow read: if authed() && (
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid in resource.data.memberIds
      );
    }
    
    // Tasks - allow if user is in memberIds of parent project
    match /{path=**}/tasks/{taskId} {
      allow read: if authed();
    }
    
    // Ideas
    match /{path=**}/ideas/{ideaId} {
      allow read: if authed();
    }

    // --- Social Collections (any authenticated user) ---
    match /social_campaigns/{docId} {
       allow read, write: if authed();
    }
    match /social_posts/{docId} { 
       allow read, write: if authed();
    }
    match /social_assets/{docId} { 
       allow read, write: if authed();
    }
    
    // --- Fallback for any unmatched paths (authenticated only) ---
    match /{document=**} {
      allow read, write: if authed();
    }
  }
}